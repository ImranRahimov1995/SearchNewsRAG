# SearchNewsRAG - Умный Поиск и Аналитика Новостей с ИИ

[![Production](https://img.shields.io/badge/production-news.aitools.az-blue)](https://news.aitools.az)
[![GitHub](https://img.shields.io/badge/github-SearchNewsRAG-black)](https://github.com/ImranRahimov1995/SearchNewsRAG)
[![Python](https://img.shields.io/badge/python-3.12-blue)](https://www.python.org/)
[![FastAPI](https://img.shields.io/badge/FastAPI-0.124-green)](https://fastapi.tiangolo.com/)
[![React](https://img.shields.io/badge/React-18-61dafb)](https://react.dev/)

**Корпоративная система семантического поиска и аналитики азербайджанских новостей с использованием технологии RAG (Retrieval-Augmented Generation), векторных эмбеддингов, LLM-анализа метаданных и интерактивной визуализации.**

---

## 🎯 Обзор Проекта

SearchNewsRAG — это полноценное full-stack приложение, которое трансформирует взаимодействие пользователей с новостными данными. Оно объединяет:
- **Автоматический сбор данных** из Telegram-каналов
- **ИИ-анализ контента** с использованием OpenAI GPT моделей
- **Векторный семантический поиск** через ChromaDB
- **Интерактивную визуализацию** в виде графа связей новостей
- **Разговорный Q&A интерфейс**

### Ключевые Возможности

| Функция | Описание |
|---------|----------|
| 🔍 **Семантический поиск** | Поиск по смыслу, а не только по ключевым словам |
| 📊 **Авто-категоризация** | ИИ классифицирует новости (политика, экономика, спорт и т.д.) |
| 🏷️ **Извлечение сущностей** | Идентификация персон, организаций, локаций |
| 💬 **Анализ тональности** | Определение позитивной/нейтральной/негативной окраски |
| 📈 **Оценка важности** | Ранжирование новостей по значимости (1-10) |
| 🌐 **Мультиязычность** | Поддержка азербайджанского, английского, русского |
| 🌌 **Вселенная новостей** | Интерактивная граф-визуализация |

---

## 🏗️ Архитектура Системы

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           СЛОЙ СБОРА ДАННЫХ                                  │
│  ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐       │
│  │ Telegram Fetcher │ -> │ Content Parser   │ -> │ JSON Storage     │       │
│  │ (Telethon)       │    │ (BeautifulSoup)  │    │ (Raw Articles)   │       │
│  └──────────────────┘    └──────────────────┘    └──────────────────┘       │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           СЛОЙ ОБРАБОТКИ ДАННЫХ                              │
│  ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐       │
│  │ Text Cleaner     │ -> │ LLM Analyzer     │ -> │ Text Chunker     │       │
│  │ (Очистка)        │    │ (OpenAI GPT-4)   │    │ (LangChain)      │       │
│  └──────────────────┘    └──────────────────┘    └──────────────────┘       │
│                                      │                                       │
│                    Извлечённые метаданные:                                   │
│                    • Категория, Сущности, Тональность                        │
│                    • Важность, Резюме, Географический охват                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           СЛОЙ ХРАНЕНИЯ                                      │
│  ┌──────────────────────────┐    ┌──────────────────────────────┐           │
│  │ ChromaDB                 │    │ PostgreSQL                   │           │
│  │ • Векторные эмбеддинги   │    │ • Статьи, Сущности           │           │
│  │ • Семантический поиск    │    │ • Источники, Связи           │           │
│  │ • Фильтрация по метаданным│   │ • Пользователи, Аналитика    │           │
│  └──────────────────────────┘    └──────────────────────────────┘           │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           СЛОЙ ПРИЛОЖЕНИЯ                                    │
│  ┌──────────────────────────────────────────────────────────────────┐       │
│  │                        FastAPI Backend                            │       │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐     │       │
│  │  │ News API   │ │ Search API │ │ Chat API   │ │ Graph API  │     │       │
│  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘     │       │
│  └──────────────────────────────────────────────────────────────────┘       │
│  ┌──────────────────────────────────────────────────────────────────┐       │
│  │                        React Frontend                             │       │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐     │       │
│  │  │ Лента      │ │ Чат        │ │ Вселенная  │ │ Аналитика  │     │       │
│  │  └────────────┘ └────────────┘ └────────────┘ └────────────┘     │       │
│  └──────────────────────────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 📦 Детальное Описание Модулей

### 1. Модуль Сбора из Telegram (`telegram_fetcher/`)

**Назначение**: Асинхронный сбор данных из новостных Telegram-каналов.

```
telegram_fetcher/
├── base.py           # TelegramCollector - обёртка над Telethon клиентом
├── services.py       # NewsCollectionService - оркестрация нескольких источников
├── config.py         # Управление API-credentials
└── parsers/
    ├── base.py       # Абстрактные интерфейсы (IURLExtractor, IContentParser)
    ├── qafqazinfo.py # Реализация парсера для конкретного сайта
    └── __main__.py   # CLI точка входа для пакетной обработки
```

**Поток Данных**:
```
Telegram Канал → Получение сообщений → Извлечение URL → Парсинг статьи → JSON
```

**Ключевые Технические Решения**:
- **Telethon** для Telegram API (асинхронный, эффективный)
- **aiohttp** для параллельных HTTP-запросов (в 2-3 раза быстрее многопоточности)
- **Semaphore** для ограничения скорости (настраиваемый параллелизм)
- **BeautifulSoup** для парсинга HTML

**Формат Вывода**:
```json
{
  "id": 12345,
  "date": "2024-11-24T10:30:00+00:00",
  "text": "Превью из Telegram...",
  "url": "https://qafqazinfo.az/news/detail/12345",
  "detail": "Полный текст статьи, извлечённый с веб-страницы...",
  "image_url": "https://qafqazinfo.az/uploads/image.jpg"
}
```

---

### 2. RAG Модуль (`rag_module/`)

**Назначение**: Полный конвейер обработки документов и их извлечения.

```
rag_module/
├── data_processing/       # Трансформация документов
│   ├── protocols.py       # Интерфейсы (ITextAnalyzer, IChunker, ITextCleaner)
│   ├── analyzers/         # Анализ контента на OpenAI
│   ├── chunkers.py        # Стратегии разделения текста
│   ├── cleaners.py        # Очистка Telegram markdown
│   ├── loaders.py         # Загрузка JSON данных
│   └── pipeline.py        # Оркестрация обработки
│
├── vector_store/          # Операции с векторной БД
│   ├── chroma_store.py    # Реализация ChromaDB
│   ├── embedding.py       # Обёртка над OpenAI эмбеддингами
│   ├── batch_processor.py # Эффективная пакетная обработка
│   └── protocols.py       # Интерфейсы хранилища
│
├── query_processing/      # Обработка пользовательских запросов
│   ├── router.py          # Классификация интента
│   ├── pipeline.py        # Трансформация запроса
│   └── llm_processor.py   # Определение языка, NER
│
├── retrieval/             # Поиск и генерация
│   ├── pipeline.py        # Оркестрация поиска
│   ├── llm_generator.py   # Синтез ответа
│   └── handlers/          # Обработчики по типам интентов
│
└── services/              # Высокоуровневые API
    ├── vectorization.py   # Сервис векторизации документов
    ├── vectorization_v2.py# С персистенцией в PostgreSQL
    └── qa_service.py      # Сервис вопрос-ответ
```

#### 2.1 Конвейер Обработки Данных

**Критический Паттерн: "Анализируй ОДИН РАЗ, Дели на МНОГО"**

Это ключевая оптимизация, экономящая 90%+ расходов на LLM:

```python
# ✅ ПРАВИЛЬНО: Анализируем полную статью ОДИН РАЗ, затем делим
full_article = article["detail"]           # Полный текст
metadata = analyzer.analyze(full_article)  # 1 вызов LLM

chunks = chunker.chunk(full_article)       # Разбиваем на части
for chunk in chunks:
    chunk.metadata = metadata              # Все чанки разделяют одни метаданные

# ❌ НЕПРАВИЛЬНО: Анализировать каждый чанк отдельно
for chunk in chunks:
    metadata = analyzer.analyze(chunk)     # N вызовов LLM - дорого!
```

**Выход LLM Анализа**:
```json
{
  "category": "politics",
  "entities": ["İlham Əliyev", "Azərbaycan", "Bakı"],
  "sentiment": "neutral",
  "sentiment_score": 0.1,
  "importance": 8,
  "summary": "Prezident İlham Əliyev Bakıda keçirilən...",
  "is_breaking": false,
  "geographic_scope": "national"
}
```

#### 2.2 Векторное Хранилище

**Стратегия Эмбеддингов**:
- Модель: `text-embedding-3-small` (экономичная) или `text-embedding-3-large` (высокое качество)
- Размер чанка: 600 символов с перекрытием 100 символов
- Разбиение: LangChain RecursiveCharacterTextSplitter

**Конфигурация ChromaDB**:
- Персистентное хранение в `./chroma_db`
- Поддержка встроенного и клиентского режимов
- Фильтрация по метаданным для гибридного поиска

#### 2.3 Обработка Запросов

**Классификация Интентов**:
| Интент | Пример | Стратегия |
|--------|--------|-----------|
| FACTOID | "Кто президент?" | Семантический поиск |
| STATISTICAL | "Сколько протестов?" | Агрегация + подсчёт |
| ANALYTICAL | "Почему выросли цены?" | Мульти-документный анализ |
| TASK | "Подытожь новости дня" | Кастомный обработчик |

#### 2.4 Сервис Вопрос-Ответ

Полный RAG конвейер:
```
Запрос пользователя → Определение языка → Перевод → NER → 
Классификация интента → Векторный поиск → Генерация LLM → 
Структурированный ответ с источниками
```

---

### 3. Backend (`backend/`)

**Назначение**: FastAPI REST API, обслуживающий фронтенд и внешние интеграции.

```
backend/src/
├── main.py            # Точка входа, lifespan, middleware
├── config.py          # Настройки из переменных окружения
├── database.py        # Асинхронная настройка SQLAlchemy
├── dependencies.py    # Контейнер внедрения зависимостей
├── news/
│   ├── router.py      # Эндпоинты новостей (/news, /categories, /graph)
│   ├── schemas.py     # Pydantic модели
│   └── services/
│       ├── postgres.py # PostgreSQL запросы
│       └── chroma.py   # Векторный поиск
├── chats/             # Управление историей чатов
├── auth/              # JWT аутентификация
└── users/             # Управление пользователями
```

**Ключевые Эндпоинты**:
| Эндпоинт | Метод | Описание |
|----------|-------|----------|
| `/news/` | GET | Пагинированный список новостей |
| `/news/categories` | GET | Категории с количеством |
| `/news/graph` | GET | Данные для граф-визуализации |
| `/news/entity-graph` | GET | Граф на основе сущностей |
| `/news/search` | POST | Семантический поиск |
| `/chats/ask` | POST | Q&A с RAG |

**Дизайн для Масштабируемости**:
- Stateless архитектура (готова к горизонтальному масштабированию)
- Async I/O везде (высокая пропускная способность)
- Пулинг соединений для баз данных
- Docker-ready с health checks

---

### 4. Frontend (`frontend/`)

**Назначение**: React SPA для просмотра новостей, чата и визуализации.

```
frontend/src/
├── App.tsx              # Корневой компонент, маршрутизация
├── components/
│   ├── ChatMessages.tsx # Отображение истории сообщений
│   ├── ChatInput.tsx    # Поле ввода с отправкой
│   ├── NewsEventCard.tsx# Карточка новости
│   └── ...
├── universe/
│   ├── UniversePage.tsx # Интерактивный граф новостей
│   ├── types.ts         # Типы данных графа
│   └── api.ts           # API вызовы графа
├── hooks/
│   ├── useChat.ts       # Управление состоянием чата
│   ├── useTheme.ts      # Тёмная/светлая тема
│   └── useLanguage.ts   # Поддержка i18n
└── i18n/                # Переводы (az, en, ru)
```

**Ключевые Функции**:
- **Лента новостей**: Фильтруемый, пагинированный список
- **Чат-интерфейс**: Q&A на естественном языке
- **Вселенная новостей**: Интерактивный граф с:
  - Перетаскиваемыми узлами (touch + mouse)
  - Pan/zoom навигацией
  - Связями на основе сущностей
  - Фильтрацией по дате
  - Цветовой кодировкой тональности

---

### 5. Инфраструктура (`docker/`)

**Docker Compose Сервисы**:
```yaml
services:
  chromadb:    # Векторная база данных
  postgres:    # Реляционная база данных
  backend:     # FastAPI приложение
  frontend:    # React приложение (nginx)
  nginx:       # Reverse proxy, SSL
```

**Сетевая Архитектура**:
```
Интернет → Nginx (80/443) → Frontend (статика)
                         → Backend (API /api/*)
                         
Backend → ChromaDB (8000)
       → PostgreSQL (5432)
```

---

## 🔧 Решённые Технические Проблемы

### 1. Оптимизация Затрат на LLM
**Проблема**: Анализ каждого чанка отдельно = дорого  
**Решение**: Паттерн "Анализируй ОДИН РАЗ, Дели на МНОГО" - снижение затрат на 90%+

### 2. Асинхронная Обработка в Масштабе
**Проблема**: Эффективная обработка тысяч статей  
**Решение**: 
- Semaphore-контролируемый параллелизм (макс. 50 параллельных)
- Пакетная обработка с отслеживанием прогресса
- Экспоненциальный backoff для rate limits

### 3. Мультиязычный Поиск
**Проблема**: Пользователи запрашивают на разных языках  
**Решение**: 
- Определение языка во время запроса
- Перевод на азербайджанский для поиска
- Ответ на исходном языке

### 4. Real-time Граф-визуализация
**Проблема**: Плавное взаимодействие с множеством узлов  
**Решение**:
- React + Framer Motion для анимаций
- Виртуальное позиционирование с viewOffset
- Поддержка touch-событий для мобильных

### 5. Качество Данных
**Проблема**: Telegram-сообщения содержат markdown, эмодзи, артефакты  
**Решение**: Кастомные очистители для:
- Удаления Telegram markdown
- Нормализации эмодзи
- Извлечения URL
- Нормализации пробелов

---

## 🚀 Локальная Разработка

### Предварительные Требования

- Docker и Docker Compose
- Python 3.12+ (для локальной разработки)
- Node.js 20+ (для разработки фронтенда)
- OpenAI API ключ
- Telegram API credentials

### Быстрый Старт

```bash
# 1. Клонировать репозиторий
git clone https://github.com/ImranRahimov1995/SearchNewsRAG.git
cd SearchNewsRAG

# 2. Скопировать шаблон переменных окружения
cp .env.example .env
# Отредактировать .env с вашими API ключами

# 3. Запустить все сервисы
docker-compose up --build

# 4. Доступ к приложению
# Фронтенд: http://localhost
# API: http://localhost/api
# API Документация: http://localhost/api/docs
```

### Команды для Разработки

```bash
# Установка зависимостей
make install

# Запуск тестов
make test

# Запуск линтеров
make lint

# Форматирование кода
make format

# Полная CI проверка
make ci

# Миграции базы данных
make migrate-up
make migrate-create name="add_new_table"
```

### Конвейер Данных

```bash
# 1. Собрать новости из Telegram
python -m telegram_fetcher --stop-date 2025-01-01

# 2. Спарсить полный текст статей
python -m telegram_fetcher.parsers --site qafqazinfo --input data/qafqazinfo.json

# 3. Векторизовать с LLM анализом
python -m rag_module vectorize \
  --source data/qafqazinfo.json \
  --source-name qafqazinfo_2025 \
  --collection news_v1

# 4. Проверить коллекцию
python -m rag_module info --collection news_v1
```

---

## 📈 Продакшн Деплой

Смотрите [docs/DEPLOYMENT.md](DEPLOYMENT.md) для детальных инструкций.

**Ключевые Моменты**:
- GitHub Actions CI/CD пайплайн
- Docker multi-stage сборки
- Nginx reverse proxy с SSL
- Health checks для всех сервисов

---

## 📚 Документация

| Документ | Описание |
|----------|----------|
| [DATA_COLLECTION.md](DATA_COLLECTION.md) | Telegram fetcher и парсеры контента |
| [VECTORIZATION_SERVICE.md](VECTORIZATION_SERVICE.md) | Конвейер обработки документов |
| [QA_SERVICE.md](QA_SERVICE.md) | Система вопрос-ответ |
| [DEPLOYMENT.md](DEPLOYMENT.md) | CI/CD и настройка продакшна |

---

## 🛠️ Технологический Стек

| Категория | Технологии |
|-----------|------------|
| **Backend** | Python 3.12, FastAPI, SQLAlchemy, Pydantic |
| **Frontend** | React 18, TypeScript, Vite, Tailwind CSS, Framer Motion |
| **AI/ML** | OpenAI GPT-4, text-embedding-3-small, LangChain |
| **Базы Данных** | PostgreSQL 16, ChromaDB |
| **Сбор Данных** | Telethon, aiohttp, BeautifulSoup |
| **Инфраструктура** | Docker, Nginx, GitHub Actions |
| **Качество Кода** | Ruff, MyPy, Black, Pytest, Pre-commit |

---

## 📄 Лицензия

MIT License - смотрите [LICENSE](../LICENSE)

---

## 👤 Автор

**Имран Рагимов**  
Email: mr.rahimov.imran@gmail.com  
GitHub: [@ImranRahimov1995](https://github.com/ImranRahimov1995)
