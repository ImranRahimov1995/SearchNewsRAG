name: CD - Production Deployment

on:
  pull_request:
    types: [closed]
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production VPS
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    environment: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push Backend image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./backend/Dockerfile
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/searchnewsrag-backend:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/searchnewsrag-backend:${{ github.sha }}
        cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/searchnewsrag-backend:buildcache
        cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/searchnewsrag-backend:buildcache,mode=max

    - name: Build and push Frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: ./frontend/Dockerfile
        push: true
        build-args: |
          VITE_API_BASE_URL=/api
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/searchnewsrag-frontend:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/searchnewsrag-frontend:${{ github.sha }}
        cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/searchnewsrag-frontend:buildcache
        cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/searchnewsrag-frontend:buildcache,mode=max

    - name: Build and push Nginx image
      uses: docker/build-push-action@v5
      with:
        context: ./docker/nginx
        file: ./docker/nginx/Dockerfile
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/searchnewsrag-nginx:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/searchnewsrag-nginx:${{ github.sha }}

    - name: Copy docker-compose to VPS
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "docker-compose.prod.yml"
        target: "/opt/searchnewsrag/"
        strip_components: 0

    - name: Deploy to VPS via SSH
      uses: appleboy/ssh-action@v1.0.3
      env:
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
        JWT_ALGORITHM: ${{ secrets.JWT_ALGORITHM }}
        JWT_ACCESS_TOKEN_EXPIRE_MINUTES: ${{ secrets.JWT_ACCESS_TOKEN_EXPIRE_MINUTES }}
        JWT_REFRESH_TOKEN_EXPIRE_DAYS: ${{ secrets.JWT_REFRESH_TOKEN_EXPIRE_DAYS }}
        EMAIL_HOST: ${{ secrets.EMAIL_HOST }}
        EMAIL_PORT: ${{ secrets.EMAIL_PORT }}
        EMAIL_USE_TLS: ${{ secrets.EMAIL_USE_TLS }}
        EMAIL_HOST_USER: ${{ secrets.EMAIL_HOST_USER }}
        EMAIL_HOST_PASSWORD: ${{ secrets.EMAIL_HOST_PASSWORD }}
        DEFAULT_FROM_EMAIL: ${{ secrets.DEFAULT_FROM_EMAIL }}
        OTP_LENGTH: ${{ secrets.OTP_LENGTH }}
        OTP_EXPIRE_MINUTES: ${{ secrets.OTP_EXPIRE_MINUTES }}
        OTP_MAX_ATTEMPTS: ${{ secrets.OTP_MAX_ATTEMPTS }}
        SUPERUSER_EMAIL: ${{ secrets.SUPERUSER_EMAIL }}
        SUPERUSER_PASSWORD: ${{ secrets.SUPERUSER_PASSWORD }}
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        envs: DOCKERHUB_USERNAME,OPENAI_API_KEY,TELEGRAM_API_ID,TELEGRAM_API_HASH,POSTGRES_DB,POSTGRES_USER,POSTGRES_PASSWORD,JWT_SECRET_KEY,JWT_ALGORITHM,JWT_ACCESS_TOKEN_EXPIRE_MINUTES,JWT_REFRESH_TOKEN_EXPIRE_DAYS,EMAIL_HOST,EMAIL_PORT,EMAIL_USE_TLS,EMAIL_HOST_USER,EMAIL_HOST_PASSWORD,DEFAULT_FROM_EMAIL,OTP_LENGTH,OTP_EXPIRE_MINUTES,OTP_MAX_ATTEMPTS,SUPERUSER_EMAIL,SUPERUSER_PASSWORD
        script: |
          cd /opt/searchnewsrag

          export DOCKERHUB_USERNAME="${DOCKERHUB_USERNAME}"
          export OPENAI_API_KEY="${OPENAI_API_KEY}"
          export TELEGRAM_API_ID="${TELEGRAM_API_ID}"
          export TELEGRAM_API_HASH="${TELEGRAM_API_HASH}"
          export POSTGRES_DB="${POSTGRES_DB}"
          export POSTGRES_USER="${POSTGRES_USER}"
          export POSTGRES_PASSWORD="${POSTGRES_PASSWORD}"
          export JWT_SECRET_KEY="${JWT_SECRET_KEY}"
          export JWT_ALGORITHM="${JWT_ALGORITHM}"
          export JWT_ACCESS_TOKEN_EXPIRE_MINUTES="${JWT_ACCESS_TOKEN_EXPIRE_MINUTES}"
          export JWT_REFRESH_TOKEN_EXPIRE_DAYS="${JWT_REFRESH_TOKEN_EXPIRE_DAYS}"
          export EMAIL_HOST="${EMAIL_HOST}"
          export EMAIL_PORT="${EMAIL_PORT}"
          export EMAIL_USE_TLS="${EMAIL_USE_TLS}"
          export EMAIL_HOST_USER="${EMAIL_HOST_USER}"
          export EMAIL_HOST_PASSWORD="${EMAIL_HOST_PASSWORD}"
          export DEFAULT_FROM_EMAIL="${DEFAULT_FROM_EMAIL}"
          export OTP_LENGTH="${OTP_LENGTH}"
          export OTP_EXPIRE_MINUTES="${OTP_EXPIRE_MINUTES}"
          export OTP_MAX_ATTEMPTS="${OTP_MAX_ATTEMPTS}"
          export SUPERUSER_EMAIL="${SUPERUSER_EMAIL}"
          export SUPERUSER_PASSWORD="${SUPERUSER_PASSWORD}"

          mv docker-compose.prod.yml docker-compose.yml

          echo "Pulling latest images..."
          docker pull ${DOCKERHUB_USERNAME}/searchnewsrag-backend:latest
          docker pull ${DOCKERHUB_USERNAME}/searchnewsrag-frontend:latest
          docker pull ${DOCKERHUB_USERNAME}/searchnewsrag-nginx:latest
          docker pull chromadb/chroma:latest
          docker pull postgres:16-alpine

          echo "Recreating services..."
          docker compose up -d --force-recreate

          echo "Cleaning up old images..."
          docker image prune -f

          echo "Deployment completed!"
          docker compose ps

    - name: Verify deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          cd /opt/searchnewsrag

          echo "Checking service health..."
          sleep 10

          if docker compose ps | grep -q "Up"; then
            echo "✅ Services are running"
            docker compose ps
          else
            echo "❌ Some services are not running"
            docker compose ps
            docker compose logs --tail=50
            exit 1
          fi
