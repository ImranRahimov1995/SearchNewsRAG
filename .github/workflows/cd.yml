name: CD - Production Deployment

on:
  pull_request:
    types: [closed]
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production VPS
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push Backend image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./backend/Dockerfile
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/searchnewsrag-backend:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/searchnewsrag-backend:${{ github.sha }}
        cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/searchnewsrag-backend:buildcache
        cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/searchnewsrag-backend:buildcache,mode=max

    - name: Build and push Frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: ./frontend/Dockerfile
        push: true
        build-args: |
          VITE_API_BASE_URL=/api
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/searchnewsrag-frontend:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/searchnewsrag-frontend:${{ github.sha }}
        cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/searchnewsrag-frontend:buildcache
        cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/searchnewsrag-frontend:buildcache,mode=max

    - name: Build and push Nginx image
      uses: docker/build-push-action@v5
      with:
        context: ./docker/nginx
        file: ./docker/nginx/Dockerfile
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/searchnewsrag-nginx:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/searchnewsrag-nginx:${{ github.sha }}

    - name: Deploy to VPS via SSH
      uses: appleboy/ssh-action@v1.0.3
      env:
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
        TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        envs: DOCKERHUB_USERNAME,OPENAI_API_KEY,TELEGRAM_API_ID,TELEGRAM_API_HASH
        script: |
          cd /opt/searchnewsrag

          export DOCKERHUB_USERNAME="${DOCKERHUB_USERNAME}"
          export OPENAI_API_KEY="${OPENAI_API_KEY}"
          export TELEGRAM_API_ID="${TELEGRAM_API_ID}"
          export TELEGRAM_API_HASH="${TELEGRAM_API_HASH}"

          echo "Pulling latest images..."
          docker pull ${DOCKERHUB_USERNAME}/searchnewsrag-backend:latest
          docker pull ${DOCKERHUB_USERNAME}/searchnewsrag-frontend:latest
          docker pull ${DOCKERHUB_USERNAME}/searchnewsrag-nginx:latest

          echo "Recreating services..."
          docker compose up -d --force-recreate --no-deps backend frontend nginx

          echo "Cleaning up old images..."
          docker image prune -f

          echo "Deployment completed!"
          docker compose ps

    - name: Verify deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          cd /opt/searchnewsrag

          echo "Checking service health..."
          sleep 10

          if docker compose ps | grep -q "Up"; then
            echo "✅ Services are running"
            docker compose ps
          else
            echo "❌ Some services are not running"
            docker compose ps
            docker compose logs --tail=50
            exit 1
          fi
